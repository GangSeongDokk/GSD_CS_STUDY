# 4.3 트랜잭션과 무결성

## 4.3.1 데이터의 무결성

### 무결성이란?

- 데이터의 정확성, 일관성, 유효성을 유지하는 것
- DB에 저장된 값과 실제 값이 일치하는 것을 보장
- 무결성의 종류
  - 개체 무결성(Entity Integrity) : 기본키로 선택된 필트는 not null
  - 참조 무결성(Referential Integrity) : 참조 관계에 있는 두 테이블의 데이터는 항상 일관된 값을 유지해야함
  - 고유 무결성(Unique Integrity) : 테이블의 특정 속성에 대해 각 레코드들이 갖는 값들이 서로 달라야함
  - 속성 무결성(Attribute Integrity) : 컬럼은 지정된 데이터 형식을 반드시 만족하는 값이어야함(ex. INT, VARCHAR)
  - 도메인 무결성(Domain Integrity) : 특정 송성 값이 미리 정의된 도메인 범위에 속해야함(ex. 성별 : 남, 여만 가능)

## 4.3.2 트랜잭션

### 트랜잭션이란?

- 데이터베이스에서 하나의 논리적인 기능을 수행하기 위한 작업의 단위
- 데이터베이스에 접근하는 방법은 `쿼리`이므로, `여러 개의 쿼리들을 하나로 묶은 것`을 `작업의 단위`라고 볼 수 있음

### 트랜잭션의 특징

> ### 원자성(Atomicity)
>
> - 트랜잭션의 연산은 데이터베이스에 모두 반영이 되거나 되지않거나 둘 중 하나
> - 연산 도중 오류가 발생하게 되면 전체 과정을 취소
> - `커밋`과 `롤백`으로 인해 데이터의 `무결성이 보장`됨
> - 커밋
>   - 쿼리 연산들이 성공적으로 처리되었다고 확정하는 명령어
>   - 트랜잭션 단위로 수행되며, 변경된 내용이 모두 저장됨
> - 롤백
>   - 에러 혹은 이슈로 인해 트랜잭션 전으로 돌아가야 할 때 사용
> - 트랜잭션 전파
>   - 이미 진행 중인 트랜잭션이 있을 경우 또다른 트랜잭션이 어떻게 동작할 것인지 경정하는 방식
>   - Spring에서는 `@Transactional` 어노테이션을 통해 여러 쿼리 관련 코드들을 하나의 트랜잭션으로 처리함
>   - 기존의 트랜잭션에 참여 하는방식, 항상 새로운 트랜잭션을 만들어 독자적으로 동작하는 방식.. 등 여러가지가 있음
>
> ### 일관성(consistency)
>
> - 허용된 방식으로만 데이터를 변경해야하는 것을 의미
> - ex) 통장 잔고가 0원 이상이어야 한다면, 잔고가 없는 통장에서 출금을 시도하는 트랜잭션은 중단됨
>
> ### 격리성, 독립성(isolation)
>
> - 트랜잭션 수행 시 다른 트랜잭션이 끼어들지 못하도록 보장하는 것을 의미 -> 트랜잭션 밖에 있는 어떠한 연산도 중간 단계의 데이터를 볼 수 없음
> - 이로 인해 모든 트랜잭션을 순차적으로 처리해야함 -> 성능저하 발생
> - 여러 개의 `격리 수준`을 두어 트랜잭션 수행 중에도 데이터를 조회할 수 있게 해줌
>
> ![image](https://3553248446-files.gitbook.io/~/files/v0/b/gitbook-legacy-files/o/assets%2F-M5HOStxvx-Jr0fqZhyW%2F-MGdOhx8aWkOCeHcri8Q%2F-MGdW-V-iOgKgGmSOVd7%2F%E1%84%80%E1%85%B3%E1%84%85%E1%85%B5%E1%86%B71.png?alt=media&token=0722018a-0d24-4586-9288-d9c306d2c263)
>
> - 격리 수준
>
>   - Serializable : 트랜잭션을 순차적으로 진행. 여러 트랜잭션이 동시에 같은 행에 접근할 수 없음. 교착 상태가 일어날 확률이 높고 성능도 가장 떨어짐
>   - Repeatalbe_read : 하나의 트랜잭션이 수행한 행을 다른 트랜잭션이 수정할 수 없도록 막지만 새로운 행을 추가하는 것은 가능
>   - `Read_committed` : 다른 트랜잭션의 `커밋이 완료된 데이터만` 조회 허용. 가장 많이 사용되는 격리 수준
>   - Read_uncommitted : 하나의 트랜잭션이 커밋되기 이전에 다른 트랜잭션에 노출되는 문제가 있음. 성능이 가장 빠름.
>
> - 격리 수준에 따라 발생하는 현상
>   - 팬텀 리드 : 한 트랜잭션 내에서 동일한 쿼리를 보냈을 때 조회 결과가 다른 경우
>   - 반복가능하지 않은 조회 : 한 트랜잭션 내의 같은 행에서 반복 조회가 발생했는데 그 값이 다른 경우(다른 트랜잭션이 커밋한 값을 읽어 버림)
>   - 더티 리드 : 한 트랜잭션이 실행 중에 다른 트랜잭션에 의해 수정되었지만 아직 `커밋되지 않은`행의 데이터를 읽었을 때 발생
>
> ### 지속성
>
> - 성공적으로 수행된 트랜잭션은 영원히 반영되어야하는 것을 의미
> - 시스템 장애가 발생해도 데이터베이스를 원상태로 회복할 수 있어야함
> - `체크섬`, `저널링`, `롤백` 제공
>   - 체크섬 : 데이터의 무결성을 확인하는 중복 검사의 한 형태. 16비트 단위, 1의 보수를 이용하여 오류를 검출
>   - 저널링 : 트랜잭션의 변경사항(커밋)에 대한 로그를 남기는 것
